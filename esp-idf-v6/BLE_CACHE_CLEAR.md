# Очистка BLE кэша на телефоне

## Проблема

Телефон кэширует GATT таблицу (сервисы, характеристики, дескрипторы) при первом подключении к BLE устройству. Даже если вы перепрошили ESP32 с правильным кодом, телефон может показывать **старые данные из кэша**.

**Признаки проблемы:**
- Телефон показывает неправильный UUID сервиса (например, `0000aaa0` вместо `6e400001`)
- Характеристики не обновляются после перепрошивки
- Приложение не может найти нужный сервис
- Подключение работает, но GATT таблица неправильная

## Решение для Android

### Метод 1: Забыть устройство (простой способ)

1. **Откройте Настройки → Bluetooth**
2. **Найдите устройство** `UM980_C6_GPS` или любое с "UM980" в названии
3. **Нажмите на значок шестеренки** (⚙️) справа от имени
4. **Нажмите "Забыть" / "Unpair"**
5. **Полностью выключите и включите Bluetooth:**
   - Откройте шторку уведомлений
   - Долгое нажатие на значок Bluetooth
   - Выключите → Подождите 5 секунд → Включите

6. **Перезагрузите ESP32** (отключите и включите питание)
7. **Попробуйте подключиться заново**

### Метод 2: Очистка кэша Bluetooth (радикальный способ)

**⚠️ Внимание:** Это удалит ВСЕ спаренные Bluetooth устройства!

1. **Откройте Настройки → Приложения**
2. **Найдите "Bluetooth"** или "Bluetooth Share"
   - На некоторых телефонах нужно нажать три точки → "Показать системные приложения"
3. **Откройте информацию о приложении Bluetooth**
4. **Нажмите "Хранилище" / "Storage"**
5. **Нажмите "Очистить данные" и "Очистить кэш"**
6. **Перезагрузите телефон**
7. **Включите Bluetooth заново**

### Метод 3: ADB команды (для разработчиков)

Если у вас включена отладка по USB:

```bash
# Подключите телефон к компьютеру
adb devices

# Очистить кэш Bluetooth
adb shell pm clear com.android.bluetooth

# Перезапустить Bluetooth
adb shell svc bluetooth disable
adb shell svc bluetooth enable
```

### Метод 4: Приложение nRF Connect

**Рекомендуется!** Это лучший способ для разработчиков BLE.

1. **Установите "nRF Connect for Mobile"** от Nordic Semiconductor
   - [Google Play](https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp)

2. **Откройте приложение → вкладка "SCANNER"**

3. **Найдите устройство** `UM980_C6_GPS`

4. **ВАЖНО: Долгое нажатие на устройство → "Delete bond information"**
   - Это удалит кэшированные данные для этого устройства

5. **Нажмите "CONNECT"**

6. **Проверьте сервисы:**
   - Должен быть `Unknown Service` с UUID `6E400001-B5A3-F393-E0A9-E50E24DCCA9E`
   - Две характеристики:
     - `6E400002...` (RX) - с флагом WRITE
     - `6E400003...` (TX) - с флагами NOTIFY + READ

7. **Включите уведомления на TX характеристике:**
   - Нажмите на `6E400003...`
   - Нажмите на стрелку вниз (↓) для включения Notify
   - Вы должны увидеть NMEA данные от GPS

## Решение для iOS

### Метод 1: Забыть устройство

1. **Откройте Настройки → Bluetooth**
2. **Найдите устройство** с именем `UM980_C6_GPS`
3. **Нажмите на (i)** справа от имени
4. **Нажмите "Забыть это устройство"**
5. **Выключите Bluetooth** в настройках
6. **Перезагрузите iPhone/iPad**
7. **Включите Bluetooth и подключитесь заново**

### Метод 2: Сброс сетевых настроек

**⚠️ Внимание:** Это удалит ВСЕ Wi-Fi пароли и Bluetooth устройства!

1. **Настройки → Основные → Перенос или сброс iPhone**
2. **Сброс → Сбросить настройки сети**
3. **Введите код-пароль**
4. **Подтвердите сброс**
5. **Телефон перезагрузится**
6. **Подключитесь к устройству заново**

### Метод 3: Использование LightBlue (рекомендуется)

1. **Установите "LightBlue" от Punchthrough**
   - [App Store](https://apps.apple.com/app/lightblue/id557428110)

2. **Откройте приложение**

3. **Если устройство спарено, нажмите (i) → "Unpair Device"**

4. **Найдите устройство в списке**

5. **Нажмите на устройство для подключения**

6. **Проверьте сервисы:**
   - Ищите UUID `6E400001-B5A3-F393-E0A9-E50E24DCCA9E`
   - Или имя "Unknown Service" (если сервис не зарегистрирован в базе Bluetooth SIG)

## Дополнительные советы

### 1. Измените имя устройства BLE

Если кэш упорно не очищается, **временно измените имя устройства** на ESP32:

```c
// В config.h измените:
#define BLE_DEVICE_NAME "GPS_TEST_123"  // Новое уникальное имя
```

Телефон воспримет это как новое устройство без кэша!

### 2. Измените MAC-адрес BLE (радикально)

**⚠️ Только для тестирования!**

```c
// В ble_service.c, в функции ble_advertise():
// Вместо:
rc = ble_gap_adv_start(BLE_OWN_ADDR_PUBLIC, NULL, BLE_HS_FOREVER, ...);

// Используйте случайный адрес:
rc = ble_gap_adv_start(BLE_OWN_ADDR_RANDOM, NULL, BLE_HS_FOREVER, ...);
```

Это заставит телефон создать новую запись без старого кэша.

### 3. Очистите NVS на ESP32

Старые bonding ключи на ESP32 тоже могут вызывать проблемы:

```bash
# Полная очистка Flash (удалит ВСЁ, включая NVS)
idf.py -p /dev/ttyUSB0 erase-flash

# Прошить заново
idf.py -p /dev/ttyUSB0 flash
```

### 4. Используйте режим разработчика на Android

1. **Включите режим разработчика:**
   - Настройки → О телефоне
   - Нажмите на "Номер сборки" 7 раз

2. **Настройки → Для разработчиков**

3. **Найдите "Bluetooth HCI snoop log"**
   - Включите для записи всего BLE трафика
   - Логи сохраняются в `/sdcard/Android/data/btsnoop_hci.log`
   - Можно открыть в Wireshark для анализа

## Проверка успешности

После очистки кэша, проверьте с помощью **nRF Connect** (Android) или **LightBlue** (iOS):

**✅ Правильно:**
```
Service: Unknown Service
UUID: 6E400001-B5A3-F393-E0A9-E50E24DCCA9E
├─ Characteristic: Unknown Characteristic
│  UUID: 6E400002-B5A3-F393-E0A9-E50E24DCCA9E
│  Properties: WRITE, WRITE NO RESPONSE
│
└─ Characteristic: Unknown Characteristic
   UUID: 6E400003-B5A3-F393-E0A9-E50E24DCCA9E
   Properties: NOTIFY, READ
   └─ Descriptor: Client Characteristic Configuration
      UUID: 0x2902
```

**❌ Неправильно (старый кэш):**
```
Service: Unknown Service
UUID: 0000aaa0-0000-1000-8000-aabbccddeeff  ← СТАРЫЙ UUID!
```

## Рекомендуемый порядок действий

**Для быстрого решения проблемы:**

1. ✅ **Забыть устройство** в настройках Bluetooth
2. ✅ **Выключить/включить Bluetooth** на телефоне
3. ✅ **Перезагрузить ESP32** (выключить/включить питание)
4. ✅ **Использовать nRF Connect** для подключения (не Nordic UART Terminal!)
5. ✅ **Проверить UUID сервиса** - должен быть `6E400001...`
6. ✅ Если не помогло → **Очистить кэш приложения Bluetooth** (Метод 2)
7. ✅ Если всё ещё не работает → **Изменить имя устройства** на ESP32

**Если ничего не помогает:**

1. ✅ **Очистить Flash ESP32:** `idf.py erase-flash`
2. ✅ **Прошить заново:** `idf.py flash`
3. ✅ **Сбросить сетевые настройки** на телефоне
4. ✅ **Попробовать с другого телефона** для проверки

## Частые ошибки

### "Service Discovery Failed"

**Причина:** Телефон не может прочитать GATT таблицу.

**Решение:**
- Проверьте, что ESP32 не перезагружается (смотрите serial monitor)
- Убедитесь, что BLE сервис зарегистрирован (ищите в логах "Registered service 6e400001")
- Попробуйте подключиться с другого телефона

### "Connection timeout" или "Disconnected immediately"

**Причина:** Проблемы с bonding/pairing.

**Решение:**
- Очистите bonding на обоих устройствах:
  - Телефон: забыть устройство
  - ESP32: `idf.py erase-flash`
- Попробуйте подключиться без pairing (некоторые приложения позволяют)

### UUID правильный, но нет данных

**Причина:** Клиент не подписался на Notify (CCCD не активирован).

**Решение:**
- В nRF Connect нажмите на стрелку вниз (↓) рядом с TX характеристикой
- Проверьте в логах ESP32: "TX Notify ENABLED"
- Убедитесь, что GPS модуль отправляет данные (должны быть в логах: "UART TX: sent...")

## Итог

**Кэш BLE - это самая частая причина проблем при разработке!**

**Лучшие инструменты для разработки:**
- **Android:** nRF Connect for Mobile
- **iOS:** LightBlue

**Золотое правило:** После каждой перепрошивки ESP32 с изменениями в BLE → забывайте устройство на телефоне!

**Если сомневаетесь:** Просто измените имя устройства (BLE_DEVICE_NAME) и телефон воспримет его как новое устройство без кэша.
