# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ Flash ESP32

## –ü—Ä–æ–±–ª–µ–º–∞

UUID —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–∞–∂–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è MAC –∞–¥—Ä–µ—Å–∞ –∏ –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–æ, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ **–ù–ï –≤ –∫—ç—à–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞**, –∞ –≤ —Å–∞–º–æ–π –ø—Ä–æ—à–∏–≤–∫–µ ESP32.

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

1. **–°—Ç–∞—Ä–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ –≤ –¥—Ä—É–≥–æ–º —Ä–∞–∑–¥–µ–ª–µ** - ESP32 –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –Ω–µ –∏–∑ —Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
2. **NVS —Ö—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ GATT** - bonding storage –º–æ–∂–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å UUID
3. **Bootloader –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é** - partition table –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Å—Ç–∞—Ä—ã–π —Ä–∞–∑–¥–µ–ª
4. **–ù–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞** - —Ñ–∞–π–ª—ã .o –º–æ–≥—É—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—ã–º–∏

## –†–µ—à–µ–Ω–∏–µ: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ + –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞

### –®–∞–≥ 1: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Flash

```bash
cd /home/user/arduino_ble_uart/esp-idf-v6

# –ü–û–õ–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –≤—Å–µ–≥–æ Flash (–≤–∫–ª—é—á–∞—è bootloader, partition table, NVS, app)
idf.py erase-flash
```

**–ß—Ç–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- ‚úÖ –£–¥–∞–ª—è–µ—Ç –í–°–ï —Ä–∞–∑–¥–µ–ª—ã (bootloader, partitions, nvs, app)
- ‚úÖ –û—á–∏—â–∞–µ—Ç bonding –∫–ª—é—á–∏
- ‚úÖ –û—á–∏—â–∞–µ—Ç GATT –∫—ç—à
- ‚úÖ –û—á–∏—â–∞–µ—Ç WiFi –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á–∏—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –®–∞–≥ 2: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–±–æ—Ä–∫–∏

```bash
# –£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
idf.py fullclean

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ fullclean –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):
rm -rf build/
rm -rf managed_components/
rm -f sdkconfig
```

### –®–∞–≥ 3: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å –Ω—É–ª—è

```bash
# –ó–∞–Ω–æ–≤–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
idf.py menuconfig
# –í menuconfig:
#   Component config ‚Üí Bluetooth ‚Üí [*] Bluetooth
#   Component config ‚Üí Bluetooth ‚Üí Bluetooth Host ‚Üí NimBLE

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
idf.py build
```

### –®–∞–≥ 4: –ü—Ä–æ—à–∏–≤–∫–∞ —Å –Ω—É–ª—è

```bash
# –ü—Ä–æ—à–∏—Ç—å –í–°–Å (bootloader + partitions + app)
idf.py -p /dev/ttyUSB0 flash

# –ò–ª–∏ —É–∫–∞–∑–∞—Ç—å —è–≤–Ω–æ –ø–æ—Ä—Ç (–µ—Å–ª–∏ ttyUSB0 –Ω–µ –Ω–∞–π–¥–µ–Ω):
idf.py -p /dev/ttyACM0 flash
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
idf.py -p /dev/ttyUSB0 monitor
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**

```
I (xxx) BLE: BLE host synced
I (xxx) BLE: üîç Service UUID (little-endian bytes):
I (xxx) BLE:    9E CA DC 24 - 0E E5 - A9 E0 - 93 F3 - A3 B5 01 00 40 6E
I (xxx) BLE:    Standard format: 6E400001-B5A3-F393-E0A9-E50E24DCCA9E
I (xxx) BLE:    Expected: 6E400001-B5A3-F393-E0A9-E50E24DCCA9E
I (xxx) BLE: ‚úÖ Custom MAC address set: CC:DD:EE:FF:00:11
I (xxx) BLE: 2M PHY enabled for maximum throughput
I (xxx) BLE: Preferred MTU set to 517 bytes
I (xxx) BLE: Registered service 6e400001-b5a3-f393-e0a9-e50e24dcca9e with handle=1
I (xxx) BLE: Advertising started: UM980_C6_GPS (UUID in adv, name in scan rsp)
```

**‚ùó –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**
- UUID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **6E400001-B5A3-F393-E0A9-E50E24DCCA9E**
- –ï—Å–ª–∏ UUID –¥—Ä—É–≥–æ–π - –∑–Ω–∞—á–∏—Ç –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ nRF Connect

–ü–æ—Å–ª–µ –ø—Ä–æ—à–∏–≤–∫–∏:

1. **–ó–∞–±—É–¥—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ** –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ:
   - Settings ‚Üí Bluetooth ‚Üí UM980_C6_GPS ‚Üí Forget

2. **–û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à nRF Connect**:
   - Settings ‚Üí Apps ‚Üí nRF Connect ‚Üí Storage ‚Üí Clear Data

3. **–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ**:
   - –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è: `UM980_C6_GPS`
   - MAC: `CC:DD:EE:FF:00:11`
   - Service UUID: `6E400001-B5A3-F393-E0A9-E50E24DCCA9E` ‚úÖ

## –ï—Å–ª–∏ UUID –≤—Å—ë –µ—â—ë –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –∫–æ–¥–µ –Ω–µ—Ç —Å—Ç–∞—Ä—ã—Ö UUID
cd /home/user/arduino_ble_uart/esp-idf-v6
grep -r "aaa0\|AAA0" main/
```

–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã - —É–¥–∞–ª–∏—Ç–µ –∏—Ö!

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å UUID

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª ble_service.c:37-47
cat main/ble_service.c | grep -A 10 "gatt_svr_svc_uuid"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```c
static const ble_uuid128_t gatt_svr_svc_uuid =
    BLE_UUID128_INIT(0x9e, 0xca, 0xdc, 0x24, 0x0e, 0xe5, 0xa9, 0xe0,
                     0x93, 0xf3, 0xa3, 0xb5, 0x01, 0x00, 0x40, 0x6e);
```

**–í–ê–ñ–ù–û:** –ü–æ—Ä—è–¥–æ–∫ –±–∞–π—Ç–æ–≤ - **little-endian** (–æ–±—Ä–∞—Ç–Ω—ã–π)!
- `0x01, 0x00, 0x40, 0x6e` = `6E400001` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 –±–∞–π—Ç–∞ UUID)

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ partition table

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é partition table
idf.py partition-table
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–∞–∑–¥–µ–ª app (factory –∏–ª–∏ ota_0).

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–æ—à–∏–≤–∞–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–ª–∞—Ç—É

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
ls -la /dev/ttyUSB* /dev/ttyACM*

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ—à–∏–≤–∞–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç!
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥: esptool.py

–ï—Å–ª–∏ `idf.py erase-flash` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å esptool (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
pip install esptool

# –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê Flash
esptool.py --chip esp32c6 --port /dev/ttyUSB0 erase_flash

# –ü—Ä–æ—à–∏–≤–∫–∞
cd /home/user/arduino_ble_uart/esp-idf-v6
idf.py -p /dev/ttyUSB0 flash
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ö–∞–∫–æ–π UUID –≤ advertising data?

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `hcitool` –Ω–∞ Linux –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ advertising data:

```bash
# –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å BLE —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å Linux + Bluetooth)
sudo hcitool lescan

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (advertising data)
sudo btmon
```

–í advertising data –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å UUID: `6E400001-B5A3-F393-E0A9-E50E24DCCA9E`

## –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

### –í –ª–æ–≥–∞—Ö ESP32:
```
‚úÖ Standard format: 6E400001-B5A3-F393-E0A9-E50E24DCCA9E
‚úÖ Expected: 6E400001-B5A3-F393-E0A9-E50E24DCCA9E
‚úÖ Registered service 6e400001-b5a3-f393-e0a9-e50e24dcca9e
```

### –í nRF Connect:
```
‚úÖ Device: UM980_C6_GPS
‚úÖ MAC: CC:DD:EE:FF:00:11
‚úÖ Service: Nordic UART Service (6E400001-...)
```

–ï—Å–ª–∏ –≤—Å—ë —Å–æ–≤–ø–∞–¥–∞–µ—Ç - **–ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!** üéâ

–ï—Å–ª–∏ –ù–ï–¢ - –ø—Ä–∏—à–ª–∏—Ç–µ:
1. –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ ESP32 (–æ—Ç boot –¥–æ advertising)
2. –°–∫—Ä–∏–Ω—à–æ—Ç nRF Connect —Å UUID
3. –í—ã–≤–æ–¥ `idf.py partition-table`
