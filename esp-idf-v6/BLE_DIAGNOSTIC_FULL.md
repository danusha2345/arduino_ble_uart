# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ BLE Nordic UART Service - –ü–æ–ª–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

## –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ ESP32

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ ESP32 –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä:

```bash
cd /home/user/arduino_ble_uart/esp-idf-v6
idf.py -p /dev/ttyUSB0 monitor
```

### –ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö:

#### 1.1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é BLE:
```
I (xxx) BLE: Initializing BLE service...
I (xxx) BLE: NimBLE port initialized (BT controller auto-initialized)
I (xxx) BLE: Security configured: Bonding=1, MITM=1, SC=0
```

#### 1.2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–æ–≤:
```
I (xxx) BLE: Registered service 6e400001-b5a3-f393-e0a9-e50e24dcca9e with handle=XX
I (xxx) BLE: Registered characteristic 6e400002-b5a3-f393-e0a9-e50e24dcca9e with def_handle=XX val_handle=XX
I (xxx) BLE: Registered characteristic 6e400003-b5a3-f393-e0a9-e50e24dcca9e with def_handle=XX val_handle=XX
I (xxx) BLE: Registered descriptor 2902 with handle=XX
```

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û:** –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–°–ï 4 —Å—Ç—Ä–æ–∫–∏:
- Service UUID: `6e400001-...` (Nordic UART Service)
- RX Characteristic: `6e400002-...`
- TX Characteristic: `6e400003-...`
- CCCD Descriptor: `2902`

#### 1.3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ advertising:
```
I (xxx) BLE: BLE host synced
I (xxx) BLE: 2M PHY enabled for maximum throughput
I (xxx) BLE: Preferred MTU set to 517 bytes
I (xxx) BLE: Advertising started: UM980_C6_GPS (UUID in adv, name in scan rsp)
```

### –ï—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –ª–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç:
- **–°–µ—Ä–≤–∏—Å –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è** ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ
- **Advertising –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ —Å BLE stack
- **–û—à–∏–±–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏** ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫

---

## –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ nRF Connect (Android/iOS)

### 2.1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (SCANNER tab)

1. –û—Ç–∫—Ä–æ–π—Ç–µ **nRF Connect**
2. –ù–∞–∂–º–∏—Ç–µ **SCAN**
3. –ù–∞–π–¥–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ **UM980_C6_GPS**

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ:**
- **Device Name**: `UM980_C6_GPS`
- **Complete List of 128-bit Service UUIDs**: `6E400001-B5A3-F393-E0A9-E50E24DCCA9E`
- **TX Power Level**: –∑–Ω–∞—á–µ–Ω–∏–µ dBm
- **Flags**: General Discoverable, BR/EDR Not Supported

**–°–∫—Ä–∏–Ω—à–æ—Ç –Ω—É–∂–µ–Ω:** –ï—Å–ª–∏ UUID –ù–ï –í–ò–î–ù–ê –≤ —Ä–µ–∫–ª–∞–º–µ - —Å–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç!

### 2.2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

1. **–ù–∞–∂–º–∏—Ç–µ CONNECT** –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ `UM980_C6_GPS`
2. –î–æ–∂–¥–∏—Ç–µ—Å—å "Connected" —Å—Ç–∞—Ç—É—Å–∞
3. **–ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç PIN** - –≤–≤–µ–¥–∏—Ç–µ `123456`

### 2.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (–ü–û–°–õ–ï –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!)

–ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è:

```
üì± Client (your phone)
   ‚îî‚îÄ‚îÄ Generic Access (0x1800)
   ‚îî‚îÄ‚îÄ Generic Attribute (0x1801)
   ‚îî‚îÄ‚îÄ Nordic UART Service (6E400001-B5A3-F393...)
       ‚îú‚îÄ‚îÄ TX Characteristic (6E400003-...)  [NOTIFY, READ]
       ‚îÇ   ‚îî‚îÄ‚îÄ Client Characteristic Configuration (0x2902)
       ‚îî‚îÄ‚îÄ RX Characteristic (6E400002-...)  [WRITE, WRITE NO RESPONSE]

üì∂ Server (ESP32)
   ... (server info)
```

**‚ö†Ô∏è –ï–°–õ–ò Nordic UART Service –ù–ï –í–ò–î–ï–ù:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—ã –ü–û–î–ö–õ–Æ–ß–ò–õ–ò–°–¨ (–Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç–µ!)
- –û—á–∏—Å—Ç–∏—Ç–µ BLE –∫—ç—à (—Å–º. –®–ê–ì 3)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ ESP32 (—Å–º. –®–ê–ì 1)

---

## –®–ê–ì 3: –û—á–∏—Å—Ç–∫–∞ BLE –∫—ç—à–∞ (–µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –≤–∏–¥–µ–Ω)

### Android:

**–ú–µ—Ç–æ–¥ 1 - –ó–∞–±—ã—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:**
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Bluetooth
2. –ù–∞–π–¥–∏—Ç–µ `UM980_C6_GPS`
3. ‚öôÔ∏è (—à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∞) ‚Üí "–ó–∞–±—ã—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"
4. –í—ã–∫–ª—é—á–∏—Ç—å/–í–∫–ª—é—á–∏—Ç—å Bluetooth
5. –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å

**–ú–µ—Ç–æ–¥ 2 - –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ nRF Connect:**
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí nRF Connect
2. –•—Ä–∞–Ω–∏–ª–∏—â–µ ‚Üí **–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ**
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nRF Connect

**–ú–µ—Ç–æ–¥ 3 - –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Bluetooth (—Ç—Ä–µ–±—É–µ—Ç root/adb):**
```bash
adb shell
pm clear com.android.bluetooth
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω
```

### iOS:

1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Bluetooth
2. (i) —Ä—è–¥–æ–º —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
3. "–ó–∞–±—ã—Ç—å —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"
4. –í—ã–∫–ª—é—á–∏—Ç—å/–í–∫–ª—é—á–∏—Ç—å Bluetooth
5. –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å

---

## –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:
1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å **–¥—Ä—É–≥–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞/–ø–ª–∞–Ω—à–µ—Ç–∞**
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å **–∫–æ–º–ø—å—é—Ç–µ—Ä–∞** (Linux/macOS: `bluetoothctl`, Windows: Bluetooth Manager)
3. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å - –ø—Ä–æ–±–ª–µ–º–∞ –≤ ESP32 –∏–ª–∏ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ

---

## –®–ê–ì 5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 5.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ UUID —Å–µ—Ä–≤–∏—Å–∞ –≤ –∫–æ–¥–µ

```bash
cd /home/user/arduino_ble_uart/esp-idf-v6
grep -A 3 "gatt_svr_svc_uuid" main/ble_service.c | head -4
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```c
static const ble_uuid128_t gatt_svr_svc_uuid =
    BLE_UUID128_INIT(0x9e, 0xca, 0xdc, 0x24, 0x0e, 0xe5, 0xa9, 0xe0,
                     0x93, 0xf3, 0xa3, 0xb5, 0x01, 0x00, 0x40, 0x6e);
```

=  `6E400001-B5A3-F393-E0A9-E50E24DCCA9E` ‚úì

### 5.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ advertising UUID

```bash
grep -A 3 "uuids128 = " main/ble_service.c
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```c
adv_fields.uuids128 = &gatt_svr_svc_uuid;
adv_fields.num_uuids128 = 1;
adv_fields.uuids128_is_complete = 1;
```

---

## –¢–ò–ü–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–∏–¥–Ω–æ, –Ω–æ –Ω–µ—Ç Nordic UART Service"

**–ü—Ä–∏—á–∏–Ω–∞:** –ö—ç—à —Ç–µ–ª–µ—Ñ–æ–Ω–∞
**–†–µ—à–µ–Ω–∏–µ:** –®–ê–ì 3 - –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π PIN –∏–ª–∏ bonding –ø—Ä–æ–±–ª–µ–º–∞
**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û—á–∏—Å—Ç–∏—Ç—å NVS –Ω–∞ ESP32
idf.py -p /dev/ttyUSB0 erase-flash
idf.py -p /dev/ttyUSB0 flash
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: "–í –ª–æ–≥–∞—Ö –µ—Å—Ç—å –æ—à–∏–±–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"

**–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:**
```
E (xxx) BLE: ble_gatts_add_svcs failed: 12
```

**–ü—Ä–∏—á–∏–Ω–∞:** GATT table overflow –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `menuconfig`:
```bash
idf.py menuconfig
# ‚Üí Component config ‚Üí Bluetooth ‚Üí NimBLE Options
# ‚Üí Maximum number of GATT services (—É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 10)
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: "Nordic UART Service –≤–∏–¥–µ–Ω, –Ω–æ CCCD –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

**–ü—Ä–∏—á–∏–Ω–∞:** –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö:
```
I (xxx) BLE: Registered descriptor 2902 with handle=XX
```

–ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ GATT table.

---

## –ß–¢–û –°–û–û–ë–©–ò–¢–¨ –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–ê –ù–ï –†–ï–®–ï–ù–ê

–°–æ–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

1. **–õ–æ–≥–∏ ESP32** (–ø–æ–ª–Ω—ã–µ, —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏):
```bash
idf.py -p /dev/ttyUSB0 monitor | tee esp32_log.txt
```

2. **–°–∫—Ä–∏–Ω—à–æ—Ç nRF Connect** (Scanner tab, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π advertising data)

3. **–°–∫—Ä–∏–Ω—à–æ—Ç nRF Connect** (–ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π GATT services)

4. **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–ª–µ—Ñ–æ–Ω–µ:**
   - –ú–æ–¥–µ–ª—å
   - Android/iOS –≤–µ—Ä—Å–∏—è
   - nRF Connect –≤–µ—Ä—Å–∏—è

5. **ESP32 –∏–Ω—Ñ–æ:**
```bash
idf.py --version
esptool.py --port /dev/ttyUSB0 flash_id
```
