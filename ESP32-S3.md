# ESP32-S3 Dual-Core Оптимизация

Этот проект поддерживает как **ESP32-C3** (одноядерный), так и **ESP32-S3** (двухъядерный) контроллеры с автоматической оптимизацией под архитектуру.

## Поддерживаемые платформы

### ESP32-C3 (по умолчанию)
- **Архитектура**: RISC-V, одно ядро
- **RAM**: 400 KB
- **Режим работы**: Однопоточный, все задачи в `loop()`
- **Компиляция**: `pio run -e esp32dev`
- **Загрузка**: `pio run -e esp32dev -t upload`

### ESP32-S3 (оптимизированный)
- **Архитектура**: Xtensa LX7, два ядра @ 240 MHz
- **RAM**: 512 KB + опциональный PSRAM
- **Режим работы**: Многопоточный с задачами на разных ядрах
- **Компиляция**: `pio run -e esp32s3`
- **Загрузка**: `pio run -e esp32s3 -t upload`

---

## Архитектура многопоточности на ESP32-S3

При компиляции для ESP32-S3 автоматически активируется двухъядерная оптимизация:

### Ядро 0 (BLE Task)
**Приоритет**: Высокий (2)  
**Стек**: 8 KB  
**Ответственность**:
- Отправка данных через BLE (TX)
- Управление BLE уведомлениями
- Мониторинг заполненности буфера

**Преимущества**:
- BLE стек не блокируется длительными операциями
- Минимальные задержки отправки
- Стабильное соединение даже при высоких нагрузках

### Ядро 1 (Data Task)
**Приоритет**: Нормальный (1)  
**Стек**: 8 KB  
**Ответственность**:
- Прием данных через BLE (RX) из буфера
- Чтение UART от GNSS модуля
- Запись в кольцевой буфер
- Определение типа данных (RTCM3 vs ASCII)

**Преимущества**:
- Не блокирует BLE операции
- Параллельная обработка приема и отправки
- Эффективное использование CPU

### Loop (Arduino Core)
**Ядро**: 1 (по умолчанию)  
**Ответственность**:
- Парсинг GPS/NMEA для дисплея
- Обработка WiFi клиентов
- Обновление OLED/TFT дисплеев
- Проверка таймаутов

---

## Преимущества ESP32-S3

### 1. Производительность
- **2x CPU мощности**: Параллельная обработка BLE и UART
- **Выше частота**: 240 MHz vs 160 MHz (ESP32-C3)
- **Больше памяти**: 512 KB SRAM + PSRAM

### 2. Стабильность BLE
- **Отдельное ядро для BLE**: Исключает конфликты с другими задачами
- **Нет блокировок**: BLE callback моментально возвращается
- **Меньше разрывов**: При интенсивном потоке NTRIP поправок

### 3. Пропускная способность
- **До 50+ KB/s через BLE**: Реальная скорость NTRIP потока
- **Нет переполнения буфера**: Параллельная обработка прием/передача
- **Плавная работа дисплеев**: Не блокируются обработкой данных

---

## Переключение между платформами

### Для ESP32-C3:
```bash
# Компиляция
pio run -e esp32dev

# Загрузка
pio run -e esp32dev -t upload

# Мониторинг
pio device monitor -e esp32dev
```

### Для ESP32-S3:
```bash
# Компиляция
pio run -e esp32s3

# Загрузка
pio run -e esp32s3 -t upload

# Мониторинг
pio device monitor -e esp32s3
```

---

## Настройка конфигурации

### platformio.ini

Оба окружения уже настроены:

**ESP32-C3** (`esp32dev`):
- Board: `esp32-c3-devkitm-1`
- Одноядерная архитектура
- Стандартная RAM

**ESP32-S3** (`esp32s3`):
- Board: `esp32-s3-devkitc-1`
- Двухъядерная архитектура
- Поддержка PSRAM
- Флаг компиляции: `-DESP32_S3=1`

### Автоматическая оптимизация

Код автоматически определяет платформу через `#ifdef ESP32_S3`:

```cpp
#ifdef ESP32_S3
    // Двухъядерный режим: задачи на разных ядрах
    xTaskCreatePinnedToCore(bleTask, "BLE", 8192, NULL, 2, &bleTaskHandle, 0);
    xTaskCreatePinnedToCore(dataTask, "Data", 8192, NULL, 1, &dataTaskHandle, 1);
#else
    // Одноядерный режим: все в loop()
#endif
```

---

## Мониторинг производительности

### ESP32-S3 Serial Output:
```
Starting BLE and WiFi to UART bridge...
ESP32-S3 detected: Starting dual-core tasks...
BLE Task started on Core 0
Data Task started on Core 1
Dual-core tasks started successfully!
```

### ESP32-C3 Serial Output:
```
Starting BLE and WiFi to UART bridge...
ESP32-C3: Running in single-core mode
```

---

## Рекомендации по выбору платформы

### Используйте ESP32-C3 если:
- ✅ Бюджетный проект
- ✅ Низкое энергопотребление критично
- ✅ Скорость NTRIP < 20 KB/s
- ✅ Нет проблем с текущей стабильностью

### Используйте ESP32-S3 если:
- ✅ Нужна максимальная стабильность BLE
- ✅ Высокая скорость NTRIP (> 30 KB/s)
- ✅ Планируется добавление функционала
- ✅ Есть проблемы с разрывами BLE на C3

---

## Устранение неполадок

### ESP32-S3 не компилируется
- Убедитесь, что установлена последняя версия PlatformIO
- Проверьте наличие флага `-DESP32_S3=1` в `platformio.ini`

### Не загружается прошивка
- Проверьте правильность выбранной платы в `platformio.ini`
- Для S3 может потребоваться удержание кнопки BOOT при загрузке

### Задачи не запускаются
- Проверьте Serial monitor: должно быть "Dual-core tasks started"
- Проверьте размер стека задач (минимум 8 KB)

---

## Дальнейшее развитие

Для ESP32-S3 можно дополнительно:
- Добавить PSRAM для больших буферов
- Увеличить размеры буферов (до 32-64 KB)
- Добавить третью задачу для логирования
- Использовать DMA для UART (еще выше производительность)

---

## Автор

Оптимизация для ESP32-S3: Claude + Warp AI Terminal  
Исходный проект: ESP32 BLE-UART Bridge for GNSS/RTK
